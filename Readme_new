# Python Service - The Architect's Hand Bridge

Servizi Python per l'automazione browser e desktop tramite AI.

---

## ğŸ—ï¸ Architettura

Questa cartella contiene **due servizi paralleli** che possono funzionare simultaneamente:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DESKTOP                                        â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   tasker_service.py        â”‚    â”‚   tool_server.py                â”‚   â”‚
â”‚   â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚    â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â”‚   â”‚
â”‚   â”‚   Porta: 8765              â”‚    â”‚   Porta: 8766                   â”‚   â”‚
â”‚   â”‚                            â”‚    â”‚                                 â”‚   â”‚
â”‚   â”‚   ğŸ§  Brain + Hands         â”‚    â”‚   ğŸ–ï¸ Hands Only                 â”‚   â”‚
â”‚   â”‚   - Lux/Gemini integrati   â”‚    â”‚   - Solo esecuzione             â”‚   â”‚
â”‚   â”‚   - Orchestrazione interna â”‚    â”‚   - Nessuna AI integrata        â”‚   â”‚
â”‚   â”‚   - Loop detection         â”‚    â”‚   - Endpoint semplici           â”‚   â”‚
â”‚   â”‚   - Self-healing           â”‚    â”‚   - Web app fa orchestrazione   â”‚   â”‚
â”‚   â”‚                            â”‚    â”‚                                 â”‚   â”‚
â”‚   â”‚   Usato da: Electron UI    â”‚    â”‚   Usato da: Web App (Lovable)   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ File

| File | Descrizione |
|------|-------------|
| `tasker_service.py` | Servizio completo con AI (Lux/Gemini) - porta 8765 |
| `tool_server.py` | Servizio esecuzione pura - porta 8766 |
| `requirements.txt` | Dipendenze Python |
| `start-tasker-service.bat` | Avvia tasker_service (8765) |
| `start-tool-server.bat` | Avvia tool_server (8766) |
| `start-both.bat` | Avvia entrambi i servizi |

---

## ğŸš€ Quick Start

### Prerequisiti

```bash
# Python 3.10+
python --version

# Installa dipendenze
pip install -r requirements.txt

# Installa browser Playwright
playwright install chromium
```

### Avvio Servizi

**Opzione 1: Solo Tool Server (per web app)**
```bash
start-tool-server.bat
# oppure
python tool_server.py
```

**Opzione 2: Solo Tasker Service (per Electron)**
```bash
start-tasker-service.bat
# oppure
python tasker_service.py
```

**Opzione 3: Entrambi**
```bash
start-both.bat
```

---

## ğŸ”Œ Porte e Endpoint

### Tool Server (8766) - Per Web App

| Endpoint | Metodo | Descrizione |
|----------|--------|-------------|
| `/health` | GET | Health check |
| `/screenshot` | POST | Cattura screenshot |
| `/click` | POST | Click a coordinate |
| `/type` | POST | Digita testo |
| `/scroll` | POST | Scroll pagina |
| `/keypress` | POST | Pressione tasti |
| `/browser/start` | POST | Avvia sessione browser |
| `/browser/stop` | POST | Chiudi sessione |
| `/browser/dom/tree` | GET | Accessibility Tree |
| `/browser/navigate` | POST | Naviga a URL |
| `/browser/current_url` | GET | URL corrente |

**Documentazione completa**: Vedi `TOOL_SERVER_API_DOCUMENTATION.md`

### Tasker Service (8765) - Per Electron

| Endpoint | Metodo | Descrizione |
|----------|--------|-------------|
| `/lux_tasks` | POST | Esegue task con Lux AI |
| `/gemini_hybrid` | POST | Esegue con Gemini Hybrid |
| `/screenshot` | POST | Screenshot (legacy) |
| ... | | (altri endpoint legacy) |

---

## ğŸ”§ Configurazione

### Variabili Ambiente (opzionali per tool_server)

```bash
# Solo se usi Lux/Gemini direttamente (non necessario per tool_server)
set OAGI_API_KEY=your-lux-api-key
set GOOGLE_AI_STUDIO_API_KEY=your-gemini-key
```

### Viewport Default

- **Tool Server**: 1280x720 (configurabile via API)
- **Tasker Service**: 1920x1080 (legacy)

---

## ğŸ“Š Quando Usare Quale Servizio

| Scenario | Servizio | Porta |
|----------|----------|-------|
| Electron app controlla automazione | tasker_service | 8765 |
| Web app controlla automazione | tool_server | 8766 |
| Web app chiama Lux/Gemini direttamente | tool_server | 8766 |
| Test endpoint isolati | tool_server | 8766 |
| CompatibilitÃ  codice legacy | tasker_service | 8765 |

---

## ğŸ§ª Test Rapido

### Test Tool Server

```bash
# Health check
curl http://127.0.0.1:8766/health

# Screenshot desktop
curl -X POST http://127.0.0.1:8766/screenshot \
  -H "Content-Type: application/json" \
  -d '{"scope": "desktop"}'

# Avvia browser
curl -X POST http://127.0.0.1:8766/browser/start \
  -H "Content-Type: application/json" \
  -d '{"start_url": "https://google.com"}'
```

### Test Tasker Service

```bash
# Health check
curl http://127.0.0.1:8765/health

# Screenshot (legacy format)
curl -X POST http://127.0.0.1:8765/screenshot \
  -H "Content-Type: application/json" \
  -d '{}'
```

---

## ğŸ”„ Flusso Tipico Web App

```
Web App (Lovable)
       â”‚
       â”‚ 1. POST /browser/start
       â–¼
   Tool Server (8766)
       â”‚
       â”‚ 2. Avvia Playwright browser
       â–¼
   Browser Session (ID: abc123)
       â”‚
       â”‚
Web App
       â”‚ 3. GET /browser/dom/tree?session_id=abc123
       â–¼
   Tool Server
       â”‚ 4. Restituisce Accessibility Tree
       â–¼
Web App (chiama Lux/Gemini API direttamente)
       â”‚ 5. AI decide: "click su Compose"
       â”‚ 6. AI trova coordinate: {x: 150, y: 200}
       â–¼
       â”‚ 7. POST /click {x: 150, y: 200, session_id: abc123}
       â–¼
   Tool Server
       â”‚ 8. Esegue click
       â–¼
   Ripeti da step 3...
```

---

## âš ï¸ Note Importanti

### Non Modificare tasker_service.py

Il `tasker_service.py` Ã¨ usato dalla Electron app esistente. **Non modificarlo** per evitare breaking changes. Aggiungi nuove funzionalitÃ  solo in `tool_server.py`.

### Coordinate Systems

Tool Server supporta diversi sistemi di coordinate:

| `coordinate_origin` | Descrizione |
|---------------------|-------------|
| `viewport` | Pixel relativi al viewport browser |
| `screen` | Pixel assoluti schermo |
| `lux_sdk` | Coordinate Lux (1260x700) â†’ auto-convertite |

### Scope

| `scope` | Target |
|---------|--------|
| `browser` | Sessione Playwright (richiede session_id) |
| `desktop` | Schermo intero via PyAutoGUI |

---

## ğŸ“š Documentazione Aggiuntiva

- `TOOL_SERVER_API_DOCUMENTATION.md` - Documentazione completa API
- `TOOL_SERVER_QUICK_REFERENCE.md` - Riferimento rapido
- `LOVABLE_INTEGRATION_GUIDE.md` - Guida integrazione web app
- `LOVABLE_HYBRID_STRATEGY.md` - Strategia DOM + Vision
- `LOVABLE_VISION_API_GUIDE.md` - Best practices Lux/Gemini

---

## ğŸ› Troubleshooting

### Porta giÃ  in uso

```bash
# Windows: trova processo
netstat -ano | findstr :8766

# Termina processo
taskkill /PID <pid> /F
```

### Playwright non trova browser

```bash
# Reinstalla browser
playwright install chromium
```

### CORS errors dalla web app

Tool Server ha CORS abilitato per tutti gli origin. Se hai problemi:
1. Verifica che il server sia in esecuzione
2. Usa `http://127.0.0.1:8766` (non `localhost`)

### Screenshot vuoto

- Verifica che il browser sia visibile (non minimizzato)
- Per desktop scope, verifica permessi screen capture

---

## ğŸ“ Changelog

### v8.0 - Tool Server
- Nuovo servizio separato su porta 8766
- API RESTful per web app
- Supporto sessioni browser multiple
- Endpoint DOM/Accessibility Tree
- Sistemi coordinate multipli

### v7.2.1 - Tasker Service
- Integrazione Lux Actor/Thinker/Tasker
- Gemini Hybrid mode
- Self-healing
- Loop detection

---

## ğŸ“„ Licenza

Proprietario - The Architect's Hand
